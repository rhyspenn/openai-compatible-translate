name: Build and Release Bob Plugin

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸å†™å…¥å†…å®¹ï¼ˆåˆ›å»ºå‘å¸ƒï¼‰
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version from info.json
      id: get_version
      run: |
        VERSION=$(grep '"version"' src/info.json | sed 's/.*"version": "\(.*\)".*/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: Build plugin
      run: |
        # åˆ›å»ºæ’ä»¶åŒ…ï¼ˆä»Ž src ç›®å½•ï¼‰
        cd src
        zip -r ../zhipu-ai-translate.bobplugin main.js info.json
        cd ..
        
        # éªŒè¯æ’ä»¶åŒ…
        echo "Plugin contents:"
        unzip -l zhipu-ai-translate.bobplugin
    
    - name: Create Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # åˆ›å»ºå‘å¸ƒè¯´æ˜Ž
        cat > release_notes.md << 'EOF'
        ## æ™ºè°±AIç¿»è¯‘æ’ä»¶ ${{ steps.get_version.outputs.version }}
        
        ### ðŸ“¦ å®‰è£…æ–¹æ³•
        1. ä¸‹è½½ `zhipu-ai-translate.bobplugin` æ–‡ä»¶
        2. åŒå‡»å®‰è£…æˆ–åœ¨ Bob ä¸­æ‰‹åŠ¨å¯¼å…¥
        3. åœ¨æ’ä»¶è®¾ç½®ä¸­é…ç½®æ™ºè°±AI API Key
        
        ### ðŸ”§ é…ç½®è¯´æ˜Ž
        - èŽ·å– API Key: https://open.bigmodel.cn/
        - æ”¯æŒ GLM-4 å’Œ GLM-4-Flash æ¨¡åž‹  
        - æ”¯æŒ 15 ç§è¯­è¨€äº’è¯‘
        - æ”¯æŒè‡ªå®šä¹‰æ¨¡åž‹é…ç½®
        
        ### ðŸ“ æ›´æ–°å†…å®¹
        è¯¦è§ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
        EOF
        
        # ä½¿ç”¨ gh CLI åˆ›å»ºå‘å¸ƒ
        gh release create ${{ github.ref_name }} \
          zhipu-ai-translate.bobplugin \
          --title "Release ${{ github.ref_name }}" \
          --notes-file release_notes.md
