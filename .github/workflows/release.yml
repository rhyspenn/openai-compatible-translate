name: Build and Release Bob Plugin

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸å†™å…¥å†…å®¹ï¼ˆåˆ›å»ºå‘å¸ƒï¼‰
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version from info.json
      id: get_version
      run: |
        VERSION=$(grep '"version"' src/info.json | sed 's/.*"version": "\(.*\)".*/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: Build plugin
      run: |
        # åˆ›å»ºæ’ä»¶åŒ…ï¼ˆä»Ž src ç›®å½•ï¼‰
        cd src
        zip -r ../openai-compatible-translate.bobplugin main.js info.json
        cd ..
        
        # éªŒè¯æ’ä»¶åŒ…
        echo "Plugin contents:"
        unzip -l openai-compatible-translate.bobplugin
    
    - name: Calculate SHA256
      id: sha256
      run: |
        SHA256=$(shasum -a 256 openai-compatible-translate.bobplugin | cut -d ' ' -f 1)
        echo "sha256=$SHA256" >> $GITHUB_OUTPUT
        echo "SHA256: $SHA256"
    
    - name: Update appcast.json
      run: |
        # æ›´æ–° appcast.json ä¸­çš„ SHA256
        VERSION="${{ steps.get_version.outputs.version }}"
        SHA256="${{ steps.sha256.outputs.sha256 }}"
        
        # ä½¿ç”¨ jq æ›´æ–° appcast.jsonï¼ˆå¦‚æžœç‰ˆæœ¬å·²å­˜åœ¨ï¼‰
        if command -v jq >/dev/null 2>&1; then
          jq --arg version "$VERSION" --arg sha256 "$SHA256" \
            '(.versions[] | select(.version == $version).sha256) = $sha256' \
            appcast.json > appcast.tmp.json && mv appcast.tmp.json appcast.json
        fi
    
    - name: Create Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # åˆ›å»ºå‘å¸ƒè¯´æ˜Ž
        cat > release_notes.md << 'EOF'
        ## OpenAI Compatible ç¿»è¯‘æ’ä»¶ ${{ steps.get_version.outputs.version }}
        
        ### ðŸ“¦ å®‰è£…æ–¹æ³•
        1. ä¸‹è½½ `openai-compatible-translate.bobplugin` æ–‡ä»¶
        2. åŒå‡»å®‰è£…æˆ–åœ¨ Bob ä¸­æ‰‹åŠ¨å¯¼å…¥
        3. åœ¨æ’ä»¶è®¾ç½®ä¸­é…ç½® API å‚æ•°
        
        ### ðŸ”§ é…ç½®è¯´æ˜Ž
        - **Base URL**: è®¾ç½® API ç«¯ç‚¹ï¼ˆå¦‚ `https://api.openai.com/v1`ï¼‰
        - **API Key**: è¾“å…¥æ‚¨çš„ API å¯†é’¥
        - **Model**: é€‰æ‹©æ¨¡åž‹ï¼ˆé»˜è®¤ `gpt-4.1`ï¼‰
        - æ”¯æŒä»»ä½• OpenAI å…¼å®¹çš„ API æœåŠ¡
        - æ”¯æŒ 35+ ç§è¯­è¨€äº’è¯‘
        
        ### ðŸŒ æ”¯æŒçš„æœåŠ¡
        - OpenAI (GPT-4, GPT-3.5-Turbo ç­‰)
        - Azure OpenAI Service
        - é€šä¹‰åƒé—®ã€æ™ºè°± AIã€ç™¾å·æ™ºèƒ½ç­‰
        - æœ¬åœ°å¤§æ¨¡åž‹ (é€šè¿‡ LM Studioã€Ollama)
        - å…¶ä»–ä»»ä½• OpenAI å…¼å®¹æœåŠ¡
        
        ### ðŸ“ æ›´æ–°å†…å®¹
        è¯¦è§ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
        
        ### ðŸ“Š æ–‡ä»¶ä¿¡æ¯
        - **æ–‡ä»¶å**: openai-compatible-translate.bobplugin
        - **SHA256**: ${{ steps.sha256.outputs.sha256 }}
        EOF
        
        # ä½¿ç”¨ gh CLI åˆ›å»ºå‘å¸ƒ
        gh release create ${{ github.ref_name }} \
          openai-compatible-translate.bobplugin \
          --title "Release ${{ github.ref_name }}" \
          --notes-file release_notes.md
